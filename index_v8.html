<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿå±‹è¡Œæƒ…åˆ†æ - Google Maps ç‰ˆ v8.3</title>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2wnsfWaDK9BA5wEkf04rFAon2yQgttlk&libraries=places,geometry,visualization"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    
    <style>
        /* æ¨£å¼è¨­å®š */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f5f5f5; }
        
        /* å°èˆªæ¬„ */
        .navbar { background: linear-gradient(135deg, #2e7d32, #43a047); color: white; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .navbar h1 { font-size: 20px; font-weight: 600; }
        .navbar-right { display: flex; align-items: center; gap: 20px; }
        .navbar-status { font-size: 12px; opacity: 0.9; }
        .btn-admin { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-admin:hover { background: rgba(255,255,255,0.3); }
        
        /* æœå°‹æ¬„ */
        .search-bar { background: white; padding: 15px 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .search-group { display: flex; align-items: center; gap: 8px; }
        .search-group label { font-size: 14px; font-weight: 600; color: #555; }
        .search-bar select, .search-bar input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; outline: none; }
        .btn-search { background: #2e7d32; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-search:hover { background: #1b5e20; }
        
        /* ç†±åŠ›åœ–æŒ‰éˆ• */
        .btn-heatmap { background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-heatmap.active { background: #2e7d32; color: white; border-color: #2e7d32; }
        
        /* æ§åˆ¶æ¬„ */
        .control-bar { background: #fff; padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; }
        .btn-control { padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; }
        
        /* ä¸»å®¹å™¨ */
        .main-container { display: flex; height: calc(100vh - 160px); }
        #map { flex: 1; height: 100%; position: relative; } /* ç¢ºä¿ relative å®šä½çµ¦ SVG ç”¨ */
        
        /* å³å´é¢æ¿ */
        .right-panel { width: 350px; background: white; border-left: 1px solid #ddd; overflow-y: auto; padding: 20px; display: none; }
        .panel-section { margin-bottom: 25px; }
        .panel-section h3 { font-size: 16px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #43a047; color: #333; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .chart-container { height: 200px; margin-top: 10px; }
        
        /* æˆ¿æºå½ˆçª— */
        .property-popup { position: fixed; bottom: 20px; right: 370px; width: 300px; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; display: none; overflow: hidden; }
        .property-popup.active { display: block; }
        .popup-header { background: #43a047; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .popup-close { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .popup-content { padding: 15px; }
        .popup-row { margin-bottom: 8px; font-size: 13px; }
        
        /* é€²éšæ¨¡å¼é–‹é—œ */
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; background: #ccc; border-radius: 20px; cursor: pointer; transition: background 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; }
        .toggle-switch.active { background: #43a047; }
        .toggle-switch.active::after { left: 22px; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ğŸ  ç§Ÿå±‹è¡Œæƒ…åˆ†æ - Google Maps ç‰ˆ v8.3</h1>
        <div class="navbar-right">
            <span id="statusText" class="navbar-status">è¼‰å…¥ä¸­...</span>
            <button class="btn-admin" id="adminBtn" onclick="showAdminMenu()">âš™ï¸ ç®¡ç†</button>
            <div class="search-group">
                <span style="font-size: 13px;">é€²éšæ¨¡å¼</span>
                <div class="toggle-switch" id="advancedToggle" onclick="showPasswordPrompt()"></div>
            </div>
        </div>
    </div>
    
    <div class="search-bar">
        <div class="search-group">
            <label for="citySelect">ğŸ“ ç¸£å¸‚</label>
            <select id="citySelect" onchange="onCityChange()">
                <option value="">é¸æ“‡ç¸£å¸‚</option>
            </select>
        </div>
        
        <div class="search-group">
            <label for="districtSelect">å€åŸŸ</label>
            <select id="districtSelect">
                <option value="">é¸æ“‡å€åŸŸ</option>
            </select>
        </div>
        
        <div class="search-group">
            <label for="address">è©³ç´°åœ°å€</label>
            <input type="text" id="address" placeholder="ä¾‹å¦‚ï¼šæ°¸å’Œè·¯76è™Ÿ">
        </div>
        
        <div class="search-group">
            <label for="buildingType">å»ºç¯‰é¡å‹</label>
            <select id="buildingType">
                <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                <option value="å…¬å¯“">å…¬å¯“</option>
                <option value="é›»æ¢¯å¤§æ¨“">é›»æ¢¯å¤§æ¨“</option>
            </select>
        </div>
        
        <div class="search-group">
            <label for="roomType">æˆ¿å‹</label>
            <select id="roomType">
                <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                <option value="å¥—æˆ¿">å¥—æˆ¿</option>
                <option value="2æˆ¿">2æˆ¿</option>
                <option value="3æˆ¿">3æˆ¿</option>
                <option value="3æˆ¿ä»¥ä¸Š">3æˆ¿ä»¥ä¸Š</option>
            </select>
        </div>
        
        <div class="search-group">
            <label for="distanceMin">ğŸ“ è·é›¢</label>
            <input type="number" id="distanceMin" value="0" min="0"> -
            <input type="number" id="distanceMax" value="5000" min="0"> ç±³
        </div>
        
        <button class="btn-search" id="searchBtn" onclick="performSearch()">æœå°‹åˆ†æ</button>
        
        <div class="search-group" style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
            <label>ğŸ”¥ ç†±åŠ›åœ–æ¨¡å¼</label>
            <div style="display: flex; gap: 8px;">
                <button class="btn-heatmap active" id="heatmapDensity" onclick="setHeatmapMode('density')">ğŸ“Š æˆ¿æºå¯†åº¦</button>
            </div>
            <div id="advancedHeatmapControls" style="display: none; margin-top: 12px;">
                <label style="font-size: 12px; color: #666;">å½±éŸ¿ç¯„åœ</label>
                <input type="range" id="heatmapRadius" min="10" max="100" value="25" step="5" oninput="updateHeatmapRadius(this.value)">
                <span id="radiusValue" style="font-size: 12px;">25px</span>
            </div>
        </div>
    </div>
    
    <div class="control-bar">
        <select id="versionSelect" onchange="onVersionChange()" class="btn-control">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
        <button class="btn-control" id="playBtn" onclick="toggleAnimation()">â–¶ï¸ æ’­æ”¾</button>
        <button class="btn-control" id="prevBtn" onclick="previousVersion()">â¬…ï¸ ä¸Šä¸€é€±</button>
        <button class="btn-control" id="nextBtn" onclick="nextVersion()">ä¸‹ä¸€é€± â¡ï¸</button>
    </div>
    
    <div class="main-container">
        <div id="map"></div>
        
        <div id="statusLegend" style="position: absolute; bottom: 30px; left: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 100; font-size: 12px;">
            <div style="font-weight: 600; margin-bottom: 5px;">æˆ¿æºç‹€æ…‹</div>
            <div><span style="color:#22C55E">â—</span> æ–°å¢ (æœ¬é€±)</div>
            <div><span style="color:#EF4444">â—</span> æŒçºŒ (æ·±ç´…è¶Šä¹…)</div>
            <div><span style="color:#999999">â—</span> æ¶ˆå¤±</div>
        </div>
        
        <div class="right-panel">
            <div class="panel-section">
                <h3>å€åŸŸçµ±è¨ˆ</h3>
                <div class="stat-row"><span class="stat-label">é€±æ¬¡</span><span class="stat-value" id="weekId">-</span></div>
                <div class="stat-row"><span class="stat-label">æˆ¿æºæ•¸</span><span class="stat-value" id="totalCount">-</span></div>
                <div class="stat-row"><span class="stat-label">æ–°å¢</span><span class="stat-value" id="newCount">-</span></div>
                <div class="stat-row"><span class="stat-label">æ¶ˆå¤±</span><span class="stat-value" id="deletedCount">-</span></div>
                <div class="stat-row"><span class="stat-label">å‡ç§Ÿ</span><span class="stat-value" id="avgRent">-</span></div>
                <div class="stat-row"><span class="stat-label">å‡åª</span><span class="stat-value" id="avgArea">-</span></div>
                <div class="stat-row"><span class="stat-label">å–®åª</span><span class="stat-value" id="rentPerPing">-</span></div>
            </div>
            
            <div class="panel-section">
                <h3>æˆ¿å‹åˆ†ä½ˆ</h3>
                <div class="chart-container"><canvas id="roomTypeChart"></canvas></div>
            </div>
            
            <div class="panel-section">
                <h3>ç§Ÿé‡‘åˆ†æ</h3>
                <div class="chart-container"><canvas id="rentAnalysisChart"></canvas></div>
            </div>
        </div>
    </div>
    
    <div class="property-popup" id="propertyPopup">
        <div class="popup-header">
            <span id="popupTitle">æˆ¿æºè©³æƒ…</span>
            <button class="popup-close" onclick="closePropertyPopup()">Ã—</button>
        </div>
        <div class="popup-content" id="popupContent"></div>
    </div>
    
    <script>
        // ============ å…¨å±€è®Šæ•¸å®šç¾© ============
        const API_BASE = '/api';
        let map;
        let markers = [];
        let queryLocationMarker = null;
        let searchRadiusCircle = null;
        let currentVersionIndex = -1;
        let versions = [];
        let currentData = null;
        let advancedMode = false;
        let animationRunning = false;
        let roomTypeChart = null;
        let rentAnalysisChart = null;
        let heatmapLayer = null;
        let deckglOverlay = null;
        let heatmapMode = 'density'; 
        let heatmapRadius = 25;
        const ADVANCED_PASSWORD = "1234";
        
        // åœ°å€æ•¸æ“šç·©å­˜
        const districtsData = {};
        
        // ============ å‡½å¼å®šç¾© ============
        
        // 1. è¨­å®šç†±åŠ›åœ–æ¨¡å¼
        function setHeatmapMode(mode) {
            heatmapMode = mode;
            
            // UI æ›´æ–°
            const btn = document.getElementById('heatmapDensity');
            if(btn) {
                btn.classList.toggle('active', mode === 'density');
            }
            
            // è‹¥æœ‰æ•¸æ“šå‰‡æ›´æ–°åœ°åœ–
            if (currentData) {
                updateHeatmap(currentData);
            }
        }
        
        function updateHeatmapRadius(value) {
            heatmapRadius = parseInt(value);
            document.getElementById('radiusValue').textContent = value + 'px';
            if (currentData) {
                updateHeatmap(currentData);
            }
        }

        // 2. åˆå§‹åŒ–æµç¨‹
        window.addEventListener('load', () => {
            initMap();
            loadDistricts();
            loadVersions();
        });
        
        function initMap() {
            try {
                const center = { lat: 25.0088, lng: 121.4988 };
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 14,
                    center: center,
                    mapTypeId: 'roadmap',
                    gestureHandling: 'greedy',
                    styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
                });
                map.addListener('click', closePropertyPopup);
            } catch (e) {
                console.error("Google Maps åˆå§‹åŒ–å¤±æ•—:", e);
                alert("Google Maps API è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢º");
            }
        }

        async function loadDistricts() {
            try {
                const response = await fetch(`${API_BASE}/available-filters`);
                const data = await response.json();
                if (data.status === 'success' && data.filters && data.filters.districts) {
                    const districts = data.filters.districts;
                    const cities = [...new Set(districts.map(d => d.city).filter(c => c))];
                    
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = '<option value="">é¸æ“‡ç¸£å¸‚</option>';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                    
                    districts.forEach(d => {
                        if (d.city && d.district) {
                            if (!districtsData[d.city]) districtsData[d.city] = [];
                            if (!districtsData[d.city].includes(d.district)) districtsData[d.city].push(d.district);
                        }
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥å€åŸŸå¤±æ•—:', error);
            }
        }

        async function loadVersions() {
            try {
                const response = await fetch(`${API_BASE}/versions`);
                const data = await response.json();
                if (data.status === 'error') throw new Error(data.message);
                
                versions = data.versions || [];
                updateVersionSelector();
                
                if (versions.length > 0) {
                    currentVersionIndex = 0; // é è¨­æœ€æ–°
                    updateVersionSelector();
                    onVersionChange(); 
                } else {
                    document.getElementById('statusText').textContent = 'ç„¡è³‡æ–™';
                }
            } catch (error) {
                console.error('åŠ è¼‰ç‰ˆæœ¬å¤±æ•—:', error);
                document.getElementById('statusText').textContent = 'é€£ç·šéŒ¯èª¤';
            }
        }

        function updateVersionSelector() {
            const select = document.getElementById('versionSelect');
            select.innerHTML = '';
            versions.forEach((version, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${version.week_id} (${version.upload_date})`;
                select.appendChild(option);
            });
            if (currentVersionIndex >= 0) select.value = currentVersionIndex;
        }

        function onCityChange() {
            const citySelect = document.getElementById('citySelect');
            const districtSelect = document.getElementById('districtSelect');
            const selectedCity = citySelect.value;
            districtSelect.innerHTML = '<option value="">é¸æ“‡å€åŸŸ</option>';
            if (selectedCity && districtsData[selectedCity]) {
                districtsData[selectedCity].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        function onVersionChange() {
            const select = document.getElementById('versionSelect');
            if (select.value === "") return;
            currentVersionIndex = parseInt(select.value);
            if (versions[currentVersionIndex]) {
                 document.getElementById('statusText').textContent = `æª¢è¦–: ${versions[currentVersionIndex].week_id}`;
            }
            performSearchWithDefaultAddress();
        }

        async function performSearchWithDefaultAddress() {
            const citySelect = document.getElementById('citySelect');
            const districtSelect = document.getElementById('districtSelect');
            const addressInput = document.getElementById('address');
            
            if (!citySelect.value) { citySelect.value = 'æ–°åŒ—å¸‚'; onCityChange(); }
            if (!districtSelect.value) districtSelect.value = 'ä¸­å’Œå€';
            if (!addressInput.value) addressInput.value = 'æ°¸å’Œè·¯';
            
            await performSearch();
        }

        // 3. æ ¸å¿ƒæœå°‹åŠŸèƒ½
        async function performSearch() {
            const city = document.getElementById('citySelect').value;
            const district = document.getElementById('districtSelect').value;
            const detailedAddress = document.getElementById('address').value;
            let address = (city || '') + (district || '') + (detailedAddress || '');
            
            const distanceMax = parseInt(document.getElementById('distanceMax').value) || 5000;
            
            if (!address) { alert('è«‹é¸æ“‡ç¸£å¸‚å’Œå€åŸŸ'); return; }

            // ç¢ºä¿å‚³é week_id
            let weekId = '';
            if (versions.length > 0 && currentVersionIndex >= 0 && versions[currentVersionIndex]) {
                weekId = versions[currentVersionIndex].week_id;
            }

            try {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: address }, async (results, status) => {
                    if (status !== 'OK') { alert('ç„¡æ³•å®šä½åœ°å€'); return; }
                    
                    const location = results[0].geometry.location;
                    const lat = location.lat();
                    const lng = location.lng();
                    
                    map.setCenter({ lat, lng });
                    map.setZoom(14);
                    
                    if (queryLocationMarker) queryLocationMarker.setMap(null);
                    queryLocationMarker = new google.maps.Marker({
                        position: { lat, lng },
                        map: map,
                        title: 'æœå°‹ä¸­å¿ƒ',
                        icon: 'https://maps.google.com/mapfiles/ms/icons/red-pushpin.png'
                    });
                    
                    // ============================================
                    // æ¢å¾©ï¼šå‰µå»ºæœå°‹ç¯„åœåœ“åœˆ (SVG è¦†è“‹å±¤)
                    // ============================================
                    if (searchRadiusCircle) {
                        searchRadiusCircle.remove();
                    }
                    
                    function createSearchRadiusCircle(centerLat, centerLng, radiusMeters) {
                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.style.position = 'absolute';
                        svg.style.top = '0';
                        svg.style.left = '0';
                        svg.style.width = '100%';
                        svg.style.height = '100%';
                        svg.style.pointerEvents = 'none';
                        svg.style.zIndex = '1';
                        
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('fill', 'rgba(67, 160, 71, 0.1)');
                        circle.setAttribute('stroke', '#43a047');
                        circle.setAttribute('stroke-width', '2');
                        circle.setAttribute('stroke-dasharray', '5,5');
                        svg.appendChild(circle);
                        
                        // æ·»åŠ åˆ°åœ°åœ–å®¹å™¨
                        const mapDiv = document.getElementById('map');
                        mapDiv.appendChild(svg);
                        
                        // æ›´æ–°åœ“åœˆä½ç½®çš„å‡½æ•¸
                        function updateCirclePosition() {
                            const bounds = map.getBounds();
                            if (!bounds) return;
                            
                            const mapRect = mapDiv.getBoundingClientRect();
                            const ne = bounds.getNorthEast();
                            const sw = bounds.getSouthWest();
                            
                            const latRange = ne.lat() - sw.lat();
                            const lngRange = ne.lng() - sw.lng();
                            
                            const cx = ((centerLng - sw.lng()) / lngRange) * mapRect.width;
                            const cy = ((ne.lat() - centerLat) / latRange) * mapRect.height;
                            
                            // ç°¡å–®ä¼°ç®—åŠå¾‘åƒç´ 
                            const radiusInDegrees = radiusMeters / 111000;
                            const radiusInPixels = (radiusInDegrees / latRange) * mapRect.height;
                            
                            circle.setAttribute('cx', cx);
                            circle.setAttribute('cy', cy);
                            circle.setAttribute('r', radiusInPixels);
                        }
                        
                        updateCirclePosition();
                        
                        const listeners = [
                            google.maps.event.addListener(map, 'bounds_changed', updateCirclePosition),
                            google.maps.event.addListener(map, 'zoom_changed', updateCirclePosition),
                            google.maps.event.addListener(map, 'center_changed', updateCirclePosition)
                        ];
                        
                        return {
                            remove: function() {
                                svg.remove();
                                listeners.forEach(l => google.maps.event.removeListener(l));
                            }
                        };
                    }
                    
                    searchRadiusCircle = createSearchRadiusCircle(lat, lng, distanceMax);
                    // ============================================

                    // å‘¼å«å¾Œç«¯ API
                    const params = new URLSearchParams({
                        address: address, city: city, district: district,
                        distance_min: document.getElementById('distanceMin').value || 0,
                        distance_max: distanceMax,
                        building_type: document.getElementById('buildingType').value,
                        room_type: document.getElementById('roomType').value,
                        week_id: weekId,
                        lat: lat, lng: lng
                    });

                    const response = await fetch(`${API_BASE}/analysis_v4?${params}`);
                    const data = await response.json();
                    
                    if (data.status === 'error') { alert('æŸ¥è©¢å¤±æ•—: ' + data.message); return; }
                    
                    currentData = data;
                    displayResults(data);
                });
            } catch (error) {
                console.error('æœå°‹å¤±æ•—:', error);
                alert('æœå°‹å¤±æ•—: ' + error.message);
            }
        }

        function displayResults(data) {
            clearMarkers();
            
            // æ›´æ–° UI æ•¸æ“š
            const summary = data.summary;
            document.getElementById('weekId').textContent = data.query.week_id || '-';
            document.getElementById('totalCount').textContent = summary.available_properties || summary.total_properties;
            document.getElementById('newCount').textContent = summary.new_properties || 0;
            document.getElementById('deletedCount').textContent = summary.inactive_properties || 0;
            document.getElementById('avgRent').textContent = `$${Math.round(summary.avg_rent_all).toLocaleString()}`;
            document.getElementById('avgArea').textContent = `${summary.avg_area.toFixed(1)} åª`;
            const rpp = summary.avg_area > 0 ? Math.round(summary.avg_rent_all / summary.avg_area) : 0;
            document.getElementById('rentPerPing').textContent = `$${rpp.toLocaleString()}/åª`;
            
            // ç¹ªè£½ Markers
            data.properties.forEach(prop => {
                const marker = new google.maps.Marker({
                    position: { lat: prop.latitude, lng: prop.longitude },
                    map: map,
                    title: prop.title,
                    icon: getMarkerIcon(prop)
                });
                marker.addListener('click', () => { if (advancedMode) showPropertyPopup(prop); });
                markers.push(marker);
            });
            
            updateHeatmap(data);
            updateCharts(data);
        }

        function getMarkerIcon(prop) {
            let color = '#22C55E'; // é è¨­æ–°å¢(ç¶ )
            if (prop.status === 'inactive') color = '#999999'; // æ¶ˆå¤±(ç°)
            else if (prop.status === 'active') {
                const weeksActive = prop.weeks_active || 1;
                const redColors = ['#FCA5A5', '#F87171', '#EF4444', '#DC2626', '#B91C1C', '#991B1B', '#7F1D1D', '#6B1A1A', '#5C1616'];
                const idx = Math.min(weeksActive - 2, redColors.length - 1);
                color = redColors[Math.max(0, idx)];
            }
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><circle cx="6" cy="6" r="5" fill="${color}" stroke="white" stroke-width="1"/></svg>`;
            return { url: 'data:image/svg+xml;base64,' + btoa(svg), scaledSize: new google.maps.Size(12, 12), anchor: new google.maps.Point(6, 6) };
        }

        function clearMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];
            if (deckglOverlay) deckglOverlay.setProps({ layers: [] });
            heatmapLayer = null;
        }

        function updateHeatmap(data) {
            // é˜²å‘†ï¼šç¢ºèª deck æ˜¯å¦å­˜åœ¨
            if (typeof deck === 'undefined') {
                console.warn('deck.gl library not loaded');
                return;
            }

            const heatmapData = data.properties.map(prop => ({
                position: [prop.longitude, prop.latitude],
                weight: heatmapMode === 'rent' ? (prop.rent_monthly / 10000) : 1
            }));
            
            const radiusPixels = advancedMode ? heatmapRadius : 25;
            
            heatmapLayer = new deck.HeatmapLayer({
                id: 'rental-heatmap',
                data: heatmapData,
                getPosition: d => d.position,
                getWeight: d => d.weight,
                radiusPixels: radiusPixels,
                colorRange: [[255, 255, 178], [254, 204, 92], [253, 141, 60], [240, 59, 32], [189, 0, 38]],
                opacity: 0.6
            });
            
            if (deckglOverlay) {
                deckglOverlay.setProps({ layers: [heatmapLayer] });
            } else {
                deckglOverlay = new deck.GoogleMapsOverlay({ layers: [heatmapLayer] });
                deckglOverlay.setMap(map);
            }
        }

        // 4. åœ–è¡¨èˆ‡å½ˆçª—
        function updateCharts(data) {
            // æˆ¿å‹åœ–è¡¨
            const roomTypes = {};
            data.properties.forEach(p => roomTypes[p.room_type || 'æœªçŸ¥'] = (roomTypes[p.room_type || 'æœªçŸ¥'] || 0) + 1);
            
            const rtCtx = document.getElementById('roomTypeChart').getContext('2d');
            if (roomTypeChart) roomTypeChart.destroy();
            roomTypeChart = new Chart(rtCtx, {
                type: 'doughnut',
                data: { labels: Object.keys(roomTypes), datasets: [{ data: Object.values(roomTypes), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            // ç§Ÿé‡‘åœ–è¡¨
            const ranges = { '<15k': 0, '15-25k': 0, '25-35k': 0, '>35k': 0 };
            data.properties.forEach(p => {
                if (p.rent_monthly < 15000) ranges['<15k']++;
                else if (p.rent_monthly < 25000) ranges['15-25k']++;
                else if (p.rent_monthly < 35000) ranges['25-35k']++;
                else ranges['>35k']++;
            });
            
            const rentCtx = document.getElementById('rentAnalysisChart').getContext('2d');
            if (rentAnalysisChart) rentAnalysisChart.destroy();
            rentAnalysisChart = new Chart(rentCtx, {
                type: 'bar',
                data: { labels: Object.keys(ranges), datasets: [{ label: 'æ•¸é‡', data: Object.values(ranges), backgroundColor: '#2e7d32' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        function showPropertyPopup(prop) {
            const popup = document.getElementById('propertyPopup');
            let html = `
                <div class="popup-row"><span class="popup-label">æ¨™é¡Œ</span><span class="popup-value">${prop.title}</span></div>
                <div class="popup-row"><span class="popup-label">åœ°å€</span><span class="popup-value">${prop.address}</span></div>
                <div class="popup-row"><span class="popup-label">ç§Ÿé‡‘</span><span class="popup-value">$${prop.rent_monthly.toLocaleString()}</span></div>
                <div class="popup-row"><span class="popup-label">åªæ•¸</span><span class="popup-value">${prop.area} åª</span></div>
                <div class="popup-row"><span class="popup-label">ç•™ç½®</span><span class="popup-value">${prop.weeks_active || 1} é€±</span></div>
            `;
            document.getElementById('popupContent').innerHTML = html;
            popup.classList.add('active');
        }

        function closePropertyPopup() {
            document.getElementById('propertyPopup').classList.remove('active');
        }

        // 5. é€²éšæ¨¡å¼èˆ‡å‹•ç•«
        function showPasswordPrompt() {
            if (advancedMode) { toggleAdvancedMode(); return; }
            const pwd = prompt('è«‹è¼¸å…¥ 4 ä½æ•¸å­—å¯†ç¢¼ (é è¨­ 1234):');
            if (pwd === ADVANCED_PASSWORD) toggleAdvancedMode();
            else if (pwd !== null) alert('å¯†ç¢¼éŒ¯èª¤');
        }

        function toggleAdvancedMode() {
            advancedMode = !advancedMode;
            document.getElementById('advancedToggle').classList.toggle('active');
            document.querySelector('.right-panel').style.display = advancedMode ? 'block' : 'none';
            document.getElementById('advancedHeatmapControls').style.display = advancedMode ? 'block' : 'none';
        }

        function toggleAnimation() {
            animationRunning = !animationRunning;
            document.getElementById('playBtn').textContent = animationRunning ? 'â¸ï¸ æš«åœ' : 'â–¶ï¸ æ’­æ”¾';
            if (animationRunning) playNext();
        }

        async function playNext() {
            if (!animationRunning) return;
            if (currentVersionIndex > 0) {
                currentVersionIndex--; // å¾€æ–°ç‰ˆæœ¬æ’­
                updateVersionSelector();
                await onVersionChange(); // ç­‰å¾…è¼‰å…¥
                setTimeout(playNext, 2000);
            } else {
                animationRunning = false;
                document.getElementById('playBtn').textContent = 'â–¶ï¸ æ’­æ”¾';
            }
        }

        function previousVersion() {
            if (currentVersionIndex < versions.length - 1) {
                currentVersionIndex++;
                updateVersionSelector();
                onVersionChange();
            }
        }

        function nextVersion() {
            if (currentVersionIndex > 0) {
                currentVersionIndex--;
                updateVersionSelector();
                onVersionChange();
            }
        }
        
        // 6. ç®¡ç†å“¡åŠŸèƒ½
        async function showAdminMenu() {
            let statusText = 'è¼‰å…¥ä¸­...';
            try {
                const response = await fetch(`${API_BASE}/admin/database-status`);
                const data = await response.json();
                if (data.status === 'success') {
                    const db = data.database;
                    statusText = `CSVæ•¸: ${db.csv_files_count}\nè¨˜éŒ„: ${db.total_records}\nDrive: ${data.google_drive.available ? 'å·²é€£æ¥' : 'æœªé€£æ¥'}`;
                }
            } catch (e) { statusText = 'é€£ç·šå¤±æ•—'; }
            
            const choice = prompt(`ç³»çµ±ç‹€æ…‹:\n${statusText}\n\n1: é‡æ–°æƒæ Drive\n2: æ¸…ç©ºè³‡æ–™åº«\n3: æ¸…é™¤å¿«å–`);
            if (choice === '1') await adminAction('rescan-csv', 'æƒæå®Œæˆ');
            else if (choice === '2') await adminReset();
            else if (choice === '3') await adminAction('clear-cache', 'å¿«å–å·²æ¸…é™¤');
        }

        async function adminAction(endpoint, successMsg) {
            try {
                const res = await fetch(`${API_BASE}/admin/${endpoint}`, { method: 'POST' });
                const data = await res.json();
                alert(data.status === 'success' ? `âœ… ${successMsg}` : `âŒ å¤±æ•—: ${data.message}`);
                if(endpoint === 'rescan-csv') loadVersions();
            } catch(e) { alert('âŒ éŒ¯èª¤: ' + e.message); }
        }

        async function adminReset() {
            const pwd = prompt('ç®¡ç†å¯†ç¢¼:');
            if(pwd !== '1234') return alert('å¯†ç¢¼éŒ¯èª¤');
            try {
                const res = await fetch(`${API_BASE}/admin/reset-database`, { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password: pwd}) 
                });
                if(res.ok) { alert('âœ… é‡ç½®æˆåŠŸ'); location.reload(); }
                else alert('âŒ å¤±æ•—');
            } catch(e) { alert('âŒ éŒ¯èª¤'); }
        }
    </script>
</body>
</html>