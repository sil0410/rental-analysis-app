# DDNS 和外網訪問配置指南

## 📋 目錄
1. [DDNS 基本概念](#ddns-基本概念)
2. [Synology DDNS 設置](#synology-ddns-設置)
3. [反向代理配置](#反向代理配置)
4. [外網訪問測試](#外網訪問測試)
5. [常見問題](#常見問題)

---

## DDNS 基本概念

### 什麼是 DDNS？

DDNS（Dynamic Domain Name System）是一種動態域名系統，它可以將您的動態 IP 地址自動映射到一個固定的域名。

**工作原理：**
```
您的家庭網路 (動態 IP)
        ↓
DDNS 服務 (Synology)
        ↓
固定域名 (my-rental-app.synology.me)
        ↓
外網用戶訪問
```

### 為什麼需要 DDNS？

- 🏠 家庭網路通常使用動態 IP（ISP 會定期更改）
- 🌐 DDNS 自動更新 IP 映射
- 🔗 用戶可以使用固定域名訪問
- 📱 無需記住複雜的 IP 地址

---

## Synology DDNS 設置

### 第 1 步：打開 NAS 控制面板

1. 在瀏覽器中輸入 NAS IP 地址
   ```
   http://192.168.1.100:5000
   或
   http://your-nas-hostname:5000
   ```

2. 輸入管理員用戶名和密碼

### 第 2 步：進入外部訪問設置

1. 左側菜單 → 「控制面板」
2. 找到「外部訪問」或「連接」
3. 選擇「DDNS」標籤

### 第 3 步：新增 DDNS 記錄

1. 點擊「新增」按鈕
2. 選擇服務提供商：**Synology**（免費）
3. 填寫以下信息：

| 設置項 | 說明 | 示例 |
|------|------|------|
| 主機名 | 您想要的域名前綴 | `my-rental-app` |
| 用戶名 | Synology 帳號 | 您的 Synology 帳號 |
| 密碼 | Synology 密碼 | 您的 Synology 密碼 |

4. 點擊「確定」保存

### 第 4 步：驗證 DDNS 狀態

1. 在 DDNS 列表中查看您新增的記錄
2. 狀態應該顯示為「正常」或「已連接」
3. 完整域名會顯示為：`my-rental-app.synology.me`

**注意：** 首次設置可能需要 5-10 分鐘才能生效

---

## 反向代理配置

### 什麼是反向代理？

反向代理是一個中間層，它將外網請求轉發到內部的 Docker 容器。

**好處：**
- ✅ 安全性更高
- ✅ 支持 HTTPS 加密
- ✅ 自動 SSL 證書管理
- ✅ 隱藏內部端口

### 配置步驟

#### 第 1 步：打開應用程序入口設置

1. 控制面板 → 「應用程序入口」（或「應用程式入口」）
2. 點擊「新增」

#### 第 2 步：填寫反向代理設置

| 設置項 | 值 | 說明 |
|------|-----|------|
| 描述 | `Rental Analysis App` | 應用名稱 |
| 協議 | `HTTPS` | 使用加密連接 |
| 主機名 | `my-rental-app.synology.me` | 您的 DDNS 域名 |
| 端口 | `443` | HTTPS 標準端口 |
| 後端伺服器 | `localhost` | 本地 |
| 後端端口 | `8000` | Docker 容器端口 |
| 啟用 HTTP/2 | ✅ 勾選 | 提高性能 |

#### 第 3 步：保存設置

1. 點擊「確定」保存
2. 等待 Synology 配置反向代理（通常 1-2 分鐘）

### 配置示意圖

```
外網用戶
    ↓
https://my-rental-app.synology.me:443
    ↓
Synology 反向代理
    ↓
localhost:8000 (Docker 容器)
    ↓
租賃分析系統
```

---

## 外網訪問測試

### 第 1 步：內部網絡測試

首先確保內部網絡可以訪問：

```
http://192.168.1.100:8000/index_v6.html
```

**預期結果：** ✅ 看到租賃分析系統界面

### 第 2 步：使用 DDNS 域名訪問

在同一網絡中，嘗試使用 DDNS 域名訪問：

```
https://my-rental-app.synology.me/index_v6.html
```

**預期結果：** ✅ 看到租賃分析系統界面

### 第 3 步：外網訪問測試

使用手機的移動網絡（不連接 WiFi），訪問：

```
https://my-rental-app.synology.me/index_v6.html
```

**預期結果：** ✅ 看到租賃分析系統界面

### 第 4 步：功能測試

1. 在地址欄輸入：`中和區永和路`
2. 點擊「搜尋分析」
3. 確認地圖上有房源顯示
4. 檢查統計數據

---

## 常見問題

### Q1: 無法連接到 DDNS 域名

**症狀：** 訪問 `https://my-rental-app.synology.me` 時顯示「無法連接」

**解決方案：**

1. **檢查 DDNS 狀態**
   - 控制面板 → 外部訪問 → DDNS
   - 確認狀態為「正常」或「已連接」

2. **等待 DNS 同步**
   - DDNS 設置後需要 5-10 分鐘才能生效
   - 等待後重試

3. **檢查 NAS 連接**
   - 確保 NAS 已連接到網絡
   - 確保 NAS 已開機

4. **清除 DNS 緩存**
   - Windows: `ipconfig /flushdns`
   - Mac: `sudo dscacheutil -flushcache`

5. **檢查防火牆**
   - 確保 NAS 防火牆允許 HTTPS (443) 端口

### Q2: 反向代理不工作

**症狀：** 訪問 DDNS 域名時顯示「502 Bad Gateway」或「無法連接」

**解決方案：**

1. **檢查 Docker 容器狀態**
   ```bash
   docker ps | grep rental_analysis_app
   ```
   - 確認容器已啟動

2. **檢查容器日誌**
   ```bash
   docker logs rental_analysis_app
   ```
   - 查看是否有錯誤信息

3. **驗證端口映射**
   ```bash
   docker port rental_analysis_app
   ```
   - 應該顯示 `8000/tcp -> 0.0.0.0:8000`

4. **重啟反向代理**
   - 控制面板 → 應用程序入口
   - 找到您的應用
   - 點擊「編輯」然後「確定」保存

5. **重啟 NAS**
   - 如果以上都不行，嘗試重啟 NAS

### Q3: HTTPS 證書錯誤

**症狀：** 瀏覽器顯示「您的連接不安全」或「證書錯誤」

**解決方案：**

1. **這是正常的** - Synology 會自動生成自簽名證書
2. **點擊「繼續前往」** 或 **「接受風險」**
3. **首次訪問可能需要等待** - Synology 正在生成證書（1-2 分鐘）

### Q4: ISP 限制端口

**症狀：** 外網無法訪問，但內網可以

**解決方案：**

1. **檢查 ISP 限制**
   - 聯繫您的 ISP 確認是否限制了 443 端口
   - 某些 ISP 限制家庭寬帶的 443 端口

2. **使用替代端口**
   - 如果 443 被限制，嘗試使用其他端口
   - 在反向代理中設置不同的端口

3. **使用 VPN**
   - 如果 ISP 限制，可以使用 VPN 作為替代方案

### Q5: 動態 IP 變更導致無法訪問

**症狀：** 之前可以訪問，現在無法訪問

**解決方案：**

1. **DDNS 應該自動更新**
   - 通常 ISP 更改 IP 後，DDNS 會在 5-10 分鐘內自動更新

2. **手動更新 DDNS**
   - 控制面板 → 外部訪問 → DDNS
   - 找到您的 DDNS 記錄
   - 點擊「更新」按鈕

3. **檢查 NAS 網絡連接**
   - 確保 NAS 已連接到網絡
   - 確保網絡連接穩定

---

## 🔒 安全建議

### 1. 設置強密碼

- 使用複雜的管理員密碼
- 定期更改密碼

### 2. 啟用防火牆

- 控制面板 → 安全性 → 防火牆
- 只允許必要的端口

### 3. 啟用 2FA（雙因素認證）

- 控制面板 → 安全性 → 帳號
- 為管理員帳號啟用 2FA

### 4. 定期備份

- 定期備份數據庫
- 使用 `database_manager.py` 工具備份

### 5. 監控訪問日誌

- 定期檢查 NAS 訪問日誌
- 查看是否有異常訪問

---

## 📞 測試清單

部署完成後，請按以下清單進行測試：

- [ ] DDNS 已設置且狀態為「正常」
- [ ] 內部網絡可以訪問 (http://192.168.1.100:8000)
- [ ] 內部網絡可以通過 DDNS 訪問 (https://your-domain.synology.me)
- [ ] 外網可以訪問 (使用手機移動網絡測試)
- [ ] 反向代理已配置
- [ ] HTTPS 連接正常
- [ ] 系統功能正常 (搜尋、地圖、統計等)
- [ ] 數據庫可以更新

---

**祝您部署順利！** 🎉
