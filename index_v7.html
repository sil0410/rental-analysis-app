<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿå±‹è¡Œæƒ…åˆ†æ - ETL æ¶æ§‹ç‰ˆ v7.0</title>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2wnsfWaDK9BA5wEkf04rFAon2yQgttlk&libraries=places,geometry,visualization"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    
    <style>
        /* CSS æ¨£å¼ä¿æŒä¸è®Š */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif; background: #f5f5f5; }
        
        /* é ‚éƒ¨å°èˆªæ¬„ */
        .navbar { background: linear-gradient(135deg, #2e7d32, #43a047); color: white; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .navbar h1 { font-size: 20px; font-weight: 600; }
        .navbar-right { display: flex; align-items: center; gap: 20px; }
        .navbar-status { font-size: 12px; opacity: 0.9; }
        .btn-admin { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .btn-admin:hover { background: rgba(255,255,255,0.3); }
        
        /* æœå°‹æ¬„ */
        .search-bar { background: white; padding: 15px 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .search-group { display: flex; align-items: center; gap: 8px; }
        .search-group label { font-size: 14px; font-weight: 600; color: #555; }
        .search-bar select, .search-bar input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; outline: none; }
        .search-bar select:focus, .search-bar input:focus { border-color: #43a047; }
        .btn-search { background: #2e7d32; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        .btn-search:hover { background: #1b5e20; }
        
        /* æ§åˆ¶æ¬„ */
        .control-bar { background: #fff; padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; }
        .btn-control { padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-control:hover { background: #f9f9f9; }
        
        /* ä¸»å®¹å™¨ */
        .main-container { display: flex; height: calc(100vh - 160px); }
        #map { flex: 1; height: 100%; }
        .right-panel { width: 350px; background: white; border-left: 1px solid #ddd; overflow-y: auto; padding: 20px; display: none; }
        .panel-section { margin-bottom: 25px; }
        .panel-section h3 { font-size: 16px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #43a047; color: #333; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .stat-label { color: #666; }
        .stat-value { font-weight: 600; color: #333; }
        .chart-container { height: 200px; margin-top: 10px; }
        
        /* æˆ¿æºè©³æƒ…å½ˆçª— */
        .property-popup { position: fixed; bottom: 20px; right: 370px; width: 300px; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; display: none; overflow: hidden; }
        .property-popup.active { display: block; }
        .popup-header { background: #43a047; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .popup-close { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .popup-content { padding: 15px; }
        .popup-row { margin-bottom: 8px; font-size: 13px; }
        .popup-label { color: #666; width: 70px; display: inline-block; }
        .popup-value { color: #333; font-weight: 500; }
        
        /* é€²éšæ¨¡å¼é–‹é—œ */
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; background: #ccc; border-radius: 20px; cursor: pointer; transition: background 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; }
        .toggle-switch.active { background: #43a047; }
        .toggle-switch.active::after { left: 22px; }
        
        /* ç†±åŠ›åœ–åœ–ä¾‹ */
        .heatmap-legend { position: absolute; bottom: 30px; left: 20px; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 50; font-size: 12px; }
        .legend-title { font-weight: 600; margin-bottom: 5px; text-align: center; }
        .legend-items { display: flex; flex-direction: column; gap: 2px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 15px; height: 10px; border-radius: 2px; }
        .btn-heatmap { background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-heatmap.active { background: #2e7d32; color: white; border-color: #2e7d32; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ğŸ  ç§Ÿå±‹è¡Œæƒ…åˆ†æ - ETL æ¶æ§‹ç‰ˆ v7.0</h1>
        <div class="navbar-right">
            <span id="statusText" class="navbar-status">è¼‰å…¥ä¸­...</span>
            <button class="btn-admin" id="adminBtn" onclick="showAdminMenu()">âš™ï¸ è³‡æ–™åº«ç®¡ç†</button>
            <div class="search-group">
                <span style="font-size: 13px;">é€²éšæ¨¡å¼</span>
                <div class="toggle-switch" id="advancedToggle" onclick="showPasswordPrompt()"></div>
            </div>
        </div>
    </div>
    
    <div class="search-bar">
        <div class="search-group">
            <label for="citySelect">ğŸ“ ç¸£å¸‚</label>
            <select id="citySelect" onchange="onCityChange()">
                <option value="">é¸æ“‡ç¸£å¸‚</option>
            </select>
        </div>
        
        <div class="search-group">
            <label for="districtSelect">å€åŸŸ</label>
            <select id="districtSelect">
                <option value="">é¸æ“‡å€åŸŸ</option>
            </select>
        </div>
        
        <div class="search-group">
            <label for="address">è©³ç´°åœ°å€</label>
            <input type="text" id="address" placeholder="ä¾‹å¦‚ï¼šæ°¸å’Œè·¯76è™Ÿ">
        </div>
        
        <div class="search-group">
            <label for="buildingType">å»ºç¯‰é¡å‹</label>
            <select id="buildingType">
                <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                <option value="å…¬å¯“">å…¬å¯“</option>
                <option value="é›»æ¢¯å¤§æ¨“">é›»æ¢¯å¤§æ¨“</option>
            </select>
        </div>
        
        <div class="search-group">
            <label for="roomType">æˆ¿å‹</label>
            <select id="roomType">
                <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                <option value="å¥—æˆ¿">å¥—æˆ¿</option>
                <option value="2æˆ¿">2æˆ¿</option>
                <option value="3æˆ¿">3æˆ¿</option>
                <option value="3æˆ¿ä»¥ä¸Š">3æˆ¿ä»¥ä¸Š</option>
            </select>
        </div>
        
        <div class="search-group">
            <label for="distanceMin">ğŸ“ è·é›¢</label>
            <input type="number" id="distanceMin" value="0" min="0"> -
            <input type="number" id="distanceMax" value="5000" min="0"> ç±³
        </div>
        
        <button class="btn-search" id="searchBtn" onclick="performSearch()">æœå°‹åˆ†æ</button>
        
        <div class="search-group" style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px; width: 100%;">
            <label>ğŸ”¥ ç†±åŠ›åœ–æ¨¡å¼</label>
            <div style="display: flex; gap: 8px;">
                <button class="btn-heatmap active" id="heatmapDensity" onclick="setHeatmapMode('density')">ğŸ“Š æˆ¿æºå¯†åº¦</button>
            </div>
            <div id="advancedHeatmapControls" style="display: none; margin-left: 20px;">
                <label style="font-size: 12px; color: #666;">ğŸ“ˆ å½±éŸ¿ç¯„åœ</label>
                <input type="range" id="heatmapRadius" min="10" max="100" value="25" step="5" oninput="updateHeatmapRadius(this.value)">
                <span id="radiusValue" style="font-size: 12px; color: #666;">25px</span>
            </div>
        </div>
    </div>
    
    <div class="control-bar">
        <select id="versionSelect" onchange="onVersionChange()" class="btn-control">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
        <button class="btn-control" id="playBtn" onclick="toggleAnimation()">â–¶ï¸ æ’­æ”¾</button>
        <button class="btn-control" id="prevBtn" onclick="previousVersion()">â¬…ï¸ ä¸Šä¸€é€±</button>
        <button class="btn-control" id="nextBtn" onclick="nextVersion()">ä¸‹ä¸€é€± â¡ï¸</button>
    </div>
    
    <div class="main-container">
        <div id="map"></div>
        
        <div class="right-panel">
            <div class="panel-section">
                <h3>å€åŸŸçµ±è¨ˆ</h3>
                <div class="stat-row"><span class="stat-label">é€±æ¬¡</span><span class="stat-value" id="weekId">-</span></div>
                <div class="stat-row"><span class="stat-label">æˆ¿æºæ•¸</span><span class="stat-value" id="totalCount">-</span></div>
                <div class="stat-row"><span class="stat-label">å¹³å‡ç§Ÿé‡‘</span><span class="stat-value" id="avgRent">-</span></div>
                <div class="stat-row"><span class="stat-label">å¹³å‡åªæ•¸</span><span class="stat-value" id="avgArea">-</span></div>
                <div class="stat-row"><span class="stat-label">å–®åªç§Ÿé‡‘</span><span class="stat-value" id="rentPerPing">-</span></div>
            </div>
            <div class="panel-section">
                <h3>æˆ¿å‹åˆ†ä½ˆ</h3>
                <div class="chart-container"><canvas id="roomTypeChart"></canvas></div>
            </div>
            <div class="panel-section">
                <h3>ç§Ÿé‡‘åˆ†æ</h3>
                <div class="chart-container"><canvas id="rentAnalysisChart"></canvas></div>
            </div>
        </div>
    </div>
    
    <div class="property-popup" id="propertyPopup">
        <div class="popup-header">
            <span id="popupTitle">æˆ¿æºè©³æƒ…</span>
            <button class="popup-close" onclick="closePropertyPopup()">Ã—</button>
        </div>
        <div class="popup-content" id="popupContent"></div>
    </div>
    
    <script>
        // é…ç½®
        const API_BASE = '/api';
        let map;
        let markers = [];
        let queryLocationMarker = null;
        let searchRadiusCircle = null;
        let currentVersionIndex = -1;
        let versions = [];
        let currentData = null;
        let advancedMode = false;
        let animationRunning = false;
        let roomTypeChart = null;
        let rentAnalysisChart = null;
        let heatmapLayer = null;
        let deckglOverlay = null;
        let heatmapMode = 'density';
        let heatmapRadius = 25;
        let districtsData = {};
        
        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initMap();
            loadDistricts();
            loadVersions();
        });
        
        async function loadDistricts() {
            try {
                const response = await fetch(`${API_BASE}/available-filters`);
                const data = await response.json();
                if (data.status === 'success' && data.filters && data.filters.districts) {
                    const districts = data.filters.districts;
                    const cities = [...new Set(districts.map(d => d.city).filter(c => c))];
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = '<option value="">é¸æ“‡ç¸£å¸‚</option>';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                    
                    districtsData = {};
                    districts.forEach(d => {
                        if (d.city && d.district) {
                            if (!districtsData[d.city]) districtsData[d.city] = [];
                            if (!districtsData[d.city].includes(d.district)) districtsData[d.city].push(d.district);
                        }
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥ç¸£å¸‚å€åŸŸå¤±æ•—:', error);
            }
        }
        
        function initMap() {
            const center = { lat: 25.0088, lng: 121.4988 };
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: center,
                mapTypeId: 'roadmap',
                styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
            });
            map.addListener('click', () => closePropertyPopup());
        }
        
        async function loadVersions() {
            try {
                const response = await fetch(`${API_BASE}/versions`);
                const data = await response.json();
                versions = data.versions || [];
                updateVersionSelector();
                if (versions.length > 0) {
                    currentVersionIndex = versions.length - 1; // é è¨­é¸æœ€æ–°çš„
                    // é€™è£¡ä¸è‡ªå‹•åŸ·è¡Œæœå°‹ï¼Œç­‰å¾…ä½¿ç”¨è€…æ“ä½œï¼Œé¿å…å‰›é–‹å°±å ±éŒ¯
                    document.getElementById('statusText').textContent = 'å°±ç·’';
                } else {
                    document.getElementById('statusText').textContent = 'ç„¡è³‡æ–™ï¼Œè«‹å…ˆåŒæ­¥æ•¸æ“šåº«';
                }
            } catch (error) {
                console.error('åŠ è¼‰ç‰ˆæœ¬å¤±æ•—:', error);
                document.getElementById('versionSelect').innerHTML = '<option value="">åŠ è¼‰å¤±æ•—</option>';
            }
        }
        
        function updateVersionSelector() {
            const select = document.getElementById('versionSelect');
            select.innerHTML = '';
            versions.forEach((version, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${version.week_id} (${version.upload_date})`;
                select.appendChild(option);
            });
            if (currentVersionIndex >= 0) select.value = currentVersionIndex;
        }
        
        function onCityChange() {
            const citySelect = document.getElementById('citySelect');
            const districtSelect = document.getElementById('districtSelect');
            const selectedCity = citySelect.value;
            districtSelect.innerHTML = '<option value="">é¸æ“‡å€åŸŸ</option>';
            if (selectedCity && districtsData[selectedCity]) {
                districtsData[selectedCity].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }
        
        function onVersionChange() {
            currentVersionIndex = parseInt(document.getElementById('versionSelect').value);
            performSearch();
        }
        
        async function performSearch() {
            const city = document.getElementById('citySelect').value;
            const district = document.getElementById('districtSelect').value;
            const detailedAddress = document.getElementById('address').value;
            const distanceMin = document.getElementById('distanceMin').value;
            const distanceMax = document.getElementById('distanceMax').value;
            
            // ç°¡æ˜“é©—è­‰
            if (!city && !detailedAddress) {
                // å¦‚æœæ˜¯è‡ªå‹•æ’­æ”¾æˆ–å‰›è¼‰å…¥ï¼Œå¯èƒ½æ²’æœ‰é¸åœ°å€ï¼Œçµ¦å€‹é è¨­è¡Œç‚º
                return;
            }
            
            // çµ„åˆå®Œæ•´åœ°å€æŸ¥è©¢åº§æ¨™
            let address = detailedAddress;
            if (city && !address.includes(city)) address = city + address;
            if (district && !address.includes(district)) address = district + address;
            if (!address) address = "å°åŒ—å¸‚"; // fallback

            try {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: address }, async (results, status) => {
                    if (status !== 'OK') {
                        console.log('ç„¡æ³•å®šä½åœ°å€');
                        return;
                    }
                    const location = results[0].geometry.location;
                    const lat = location.lat();
                    const lng = location.lng();
                    
                    // ç§»å‹•åœ°åœ–
                    map.setCenter({ lat, lng });
                    
                    // ç¹ªè£½åœ“åœˆ (çœç•¥éƒ¨åˆ† code ä»¥ä¿æŒç°¡æ½”)
                    if (queryLocationMarker) queryLocationMarker.setMap(null);
                    queryLocationMarker = new google.maps.Marker({
                        position: { lat, lng }, map: map, title: 'æœå°‹ä¸­å¿ƒ'
                    });

                    // å‘¼å« API
                    const weekId = versions[currentVersionIndex]?.week_id;
                    const params = new URLSearchParams({
                        address: address,
                        city: city || '',
                        district: district || '',
                        distance_min: distanceMin,
                        distance_max: distanceMax,
                        building_type: document.getElementById('buildingType').value,
                        room_type: document.getElementById('roomType').value,
                        week_id: weekId || '',
                        lat: lat,
                        lng: lng
                    });
                    
                    document.getElementById('statusText').textContent = 'æŸ¥è©¢ä¸­...';
                    const response = await fetch(`${API_BASE}/analysis_v4?${params}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        document.getElementById('statusText').textContent = `æŸ¥è©¢å®Œæˆ (ç­†æ•¸: ${data.query.count})`;
                        currentData = data;
                        displayResults(data);
                    } else {
                        document.getElementById('statusText').textContent = 'æŸ¥è©¢ç„¡çµæœ';
                    }
                });
            } catch (e) {
                console.error(e);
            }
        }

        function displayResults(data) {
            clearMarkers();
            
            // æ›´æ–°å³å´é¢æ¿
            const summary = data.summary;
            document.getElementById('weekId').textContent = data.query.week_id;
            document.getElementById('totalCount').textContent = summary.total_properties;
            document.getElementById('avgRent').textContent = `$${summary.avg_rent_all}`;
            document.getElementById('avgArea').textContent = summary.avg_area;
            const perPing = summary.avg_area > 0 ? Math.round(summary.avg_rent_all / summary.avg_area) : 0;
            document.getElementById('rentPerPing').textContent = `$${perPing}/åª`;
            
            // ç¹ªè£½åœ°åœ–æ¨™è¨˜
            const heatmapData = [];
            data.properties.forEach(prop => {
                const marker = new google.maps.Marker({
                    position: { lat: prop.latitude, lng: prop.longitude },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 5,
                        fillColor: '#FF0000',
                        fillOpacity: 0.8,
                        strokeWeight: 1,
                        strokeColor: 'white'
                    }
                });
                marker.addListener('click', () => {
                    if (advancedMode) showPropertyPopup(prop);
                });
                markers.push(marker);
                heatmapData.push({position: [prop.longitude, prop.latitude], weight: 1});
            });
            
            updateHeatmap(heatmapData);
            updateCharts(data);
        }
        
        function clearMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];
            if (deckglOverlay) deckglOverlay.setProps({ layers: [] });
        }
        
        function updateHeatmap(data) {
            if (!data.length) return;
            heatmapLayer = new deck.HeatmapLayer({
                id: 'rental-heatmap',
                data: data,
                getPosition: d => d.position,
                getWeight: d => d.weight,
                radiusPixels: heatmapRadius,
                intensity: 1,
                threshold: 0.05
            });
            if (deckglOverlay) {
                deckglOverlay.setProps({ layers: [heatmapLayer] });
            } else {
                deckglOverlay = new deck.GoogleMapsOverlay({ layers: [heatmapLayer] });
                deckglOverlay.setMap(map);
            }
        }
        
        function showPropertyPopup(prop) {
            const content = document.getElementById('popupContent');
            content.innerHTML = `
                <div class="popup-row"><span class="popup-label">æ¨™é¡Œ</span><span class="popup-value">${prop.title}</span></div>
                <div class="popup-row"><span class="popup-label">ç§Ÿé‡‘</span><span class="popup-value">$${prop.rent_monthly}</span></div>
                <div class="popup-row"><span class="popup-label">åªæ•¸</span><span class="popup-value">${prop.area} åª</span></div>
                <div class="popup-row"><span class="popup-label">æ¨“å±¤</span><span class="popup-value">${prop.floor}</span></div>
            `;
            document.getElementById('propertyPopup').classList.add('active');
        }
        
        function closePropertyPopup() {
            document.getElementById('propertyPopup').classList.remove('active');
        }

        // ============ åœ–è¡¨ç›¸é—œ ============
        function updateCharts(data) {
            // ç°¡åŒ–ç‰ˆåœ–è¡¨æ›´æ–°é‚è¼¯
            const roomCtx = document.getElementById('roomTypeChart').getContext('2d');
            const rentCtx = document.getElementById('rentAnalysisChart').getContext('2d');
            
            // æˆ¿å‹
            const types = {};
            data.properties.forEach(p => types[p.room_type] = (types[p.room_type]||0)+1);
            if (roomTypeChart) roomTypeChart.destroy();
            roomTypeChart = new Chart(roomCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(types),
                    datasets: [{ data: Object.values(types), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }]
                }
            });
            
            // ç§Ÿé‡‘
            const ranges = {'<15k':0, '15-25k':0, '25-35k':0, '>35k':0};
            data.properties.forEach(p => {
                const r = p.rent_monthly;
                if(r<15000) ranges['<15k']++;
                else if(r<25000) ranges['15-25k']++;
                else if(r<35000) ranges['25-35k']++;
                else ranges['>35k']++;
            });
            if (rentAnalysisChart) rentAnalysisChart.destroy();
            rentAnalysisChart = new Chart(rentCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{ label:'æ•¸é‡', data: Object.values(ranges), backgroundColor: '#4caf50' }]
                }
            });
        }
        
        // ============ é€²éšæ¨¡å¼ & å¯†ç¢¼ ============
        const ADVANCED_PASSWORD = "1234";
        function showPasswordPrompt() {
            if (advancedMode) { toggleAdvancedMode(); return; }
            const pwd = prompt('è«‹è¼¸å…¥å¯†ç¢¼ (1234):');
            if (pwd === ADVANCED_PASSWORD) toggleAdvancedMode();
            else if (pwd !== null) alert('å¯†ç¢¼éŒ¯èª¤');
        }
        function toggleAdvancedMode() {
            advancedMode = !advancedMode;
            document.getElementById('advancedToggle').classList.toggle('active');
            document.querySelector('.right-panel').style.display = advancedMode ? 'block' : 'none';
            document.getElementById('advancedHeatmapControls').style.display = advancedMode ? 'block' : 'none';
        }
        function updateHeatmapRadius(val) {
            heatmapRadius = parseInt(val);
            document.getElementById('radiusValue').textContent = val + 'px';
            if (currentData) {
                 const heatmapData = currentData.properties.map(p => ({position: [p.longitude, p.latitude], weight: 1}));
                 updateHeatmap(heatmapData);
            }
        }
        
        // ============ ç®¡ç†å“¡åŠŸèƒ½ (ä¿®å¾©ç‰ˆ) ============
        
        // 1. é¡¯ç¤ºç‹€æ…‹é¸å–®
        async function showAdminMenu() {
            let statusText = 'è¼‰å…¥ä¸­...';
            try {
                // ä½¿ç”¨æ–°çš„ API endpoint
                const response = await fetch(`${API_BASE}/admin/status`);
                const data = await response.json();
                
                const db = data.database;
                statusText = `ğŸ“Š è³‡æ–™åº«ç‹€æ…‹:\n\nç¸½ç­†æ•¸: ${db.total_properties}\nå·²åŒæ­¥æª”æ¡ˆ: ${db.synced_files_count}\nGoogle Drive: ${data.drive_connected ? 'âœ… å·²é€£æ¥' : 'âŒ æœªé€£æ¥'}`;
                
                if (db.recent_activity && db.recent_activity.length > 0) {
                    statusText += `\n\næœ€è¿‘æ´»å‹•:\n${db.recent_activity[0].file} (${db.recent_activity[0].status})`;
                }
                
            } catch (error) {
                statusText = `ç„¡æ³•é€£æ¥ä¼ºæœå™¨: ${error.message}`;
            }
            
            const choice = prompt(`${statusText}\n\nè«‹é¸æ“‡æ“ä½œ:\n1 = ğŸ”„ åŒæ­¥ Google Drive (Sync)\n2 = ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™åº« (Reset)\n0 = å–æ¶ˆ`);
            
            if (choice === '1') {
                await syncGoogleDrive();
            } else if (choice === '2') {
                await resetDatabase();
            }
        }
        
        // 2. è§¸ç™¼åŒæ­¥ (ETL)
        async function syncGoogleDrive() {
            const password = prompt('è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥é–‹å§‹åŒæ­¥ (é è¨­ 1234):');
            if (password === null) return;
            
            const statusDiv = document.getElementById('statusText');
            statusDiv.textContent = 'æ­£åœ¨å•Ÿå‹•åŒæ­¥ä»»å‹™...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/sync-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`âœ… åŒæ­¥ä»»å‹™å·²å•Ÿå‹•ï¼\n\nä¼ºæœå™¨æ­£åœ¨èƒŒæ™¯ä¸‹è¼‰ä¸¦è™•ç†æª”æ¡ˆã€‚\næ‚¨å¯ä»¥éå¹¾åˆ†é˜å¾Œå†æ¬¡æŸ¥çœ‹ã€Œç‹€æ…‹ã€ç¢ºèªé€²åº¦ã€‚`);
                    statusDiv.textContent = 'åŒæ­¥ä»»å‹™åŸ·è¡Œä¸­ (èƒŒæ™¯)';
                } else {
                    alert(`âŒ å•Ÿå‹•å¤±æ•—: ${data.detail || 'å¯†ç¢¼éŒ¯èª¤æˆ– Drive æœªé€£æ¥'}`);
                    statusDiv.textContent = 'åŒæ­¥å•Ÿå‹•å¤±æ•—';
                }
            } catch (error) {
                alert(`âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`);
                statusDiv.textContent = 'é€£ç·šéŒ¯èª¤';
            }
        }
        
        // 3. é‡ç½®è³‡æ–™åº«
        async function resetDatabase() {
            const password = prompt('è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼\nè«‹è¼¸å…¥å¯†ç¢¼ç¢ºèª (é è¨­ 1234):');
            if (password === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/reset-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                
                if (response.ok) {
                    alert('âœ… è³‡æ–™åº«å·²æ¸…ç©ºã€‚è«‹é‡æ–°åŸ·è¡ŒåŒæ­¥ã€‚');
                    location.reload();
                } else {
                    alert('âŒ æ¸…ç©ºå¤±æ•—ï¼Œå¯†ç¢¼å¯èƒ½éŒ¯èª¤ã€‚');
                }
            } catch (error) {
                alert('âŒ éŒ¯èª¤: ' + error.message);
            }
        }
        
        // å‹•ç•«æ§åˆ¶
        function toggleAnimation() {
            animationRunning = !animationRunning;
            document.getElementById('playBtn').textContent = animationRunning ? 'â¸ï¸ æš«åœ' : 'â–¶ï¸ æ’­æ”¾';
            if (animationRunning) playNext();
        }
        async function playNext() {
            if (!animationRunning) return;
            if (currentVersionIndex < versions.length - 1) {
                currentVersionIndex++;
                updateVersionSelector();
                await performSearch(); // ä½¿ç”¨ performSearch ä¾†è§¸ç™¼æ›´æ–°
                setTimeout(playNext, 2000);
            } else {
                animationRunning = false;
                document.getElementById('playBtn').textContent = 'â–¶ï¸ æ’­æ”¾';
            }
        }
        function previousVersion() {
            if (currentVersionIndex > 0) { currentVersionIndex--; updateVersionSelector(); onVersionChange(); }
        }
        function nextVersion() {
            if (currentVersionIndex < versions.length - 1) { currentVersionIndex++; updateVersionSelector(); onVersionChange(); }
        }
    </script>
</body>
</html>